stages:
  - build
  - lint
  - format
  - test
  - deploy

build-job:
  stage: build
  image: node:latest
  script:
    - echo "Hello, $GITLAB_USER_LOGIN!"
    - npm install

lint-js:
  stage: lint
  image: node:latest
  script:
    - npm run lint

format-check:
  stage: format
  image: node:latest
  script:
    - npm run format:check
  allow_failure: true

phpunit-tests:
  stage: test
  image: php:latest
  script:
    - ./vendor/bin/phpunit html/test/

unit-test:
  stage: test
  image: node:latest
  script:
    - cd html/test
    - npm install
    - npm test
  artifacts:
    paths:
      - coverage/
    when: always
    reports:
      junit:
        - junit.xml

deploy-prod:
  stage: deploy
  image: debian:12.4
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - chmod 400 "$SSH_PRIVATE_KEY"
    - ssh-add "$SSH_PRIVATE_KEY"
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan cis4250w24-08.socs.uoguelph.ca >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "On $CI_COMMIT_REF_NAME branch, copying html files..."
    - scp -r html/* socs@cis4250w24-08.socs.uoguelph.ca:/var/www/html/
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  environment: production
